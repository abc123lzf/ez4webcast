<!DOCTYPE html>
<html>

<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <title>flv.js demo</title>
    <link rel="stylesheet" type="text/css" href="css/demo.css" />
    <script src="js/jquery-3.4.1.min.js"></script>
</head>

<body>
    <div class="headerpage"></div>
    <div class="barrageHead">
        <img src="https://apic.douyucdn.cn/upload/avanew/face/201707/20/15/5943dc2abe5848085036bd78b3a1077f_big.jpg">
        <span >【直播中】中越 AG vs eStar</span>
        <embed style="float: right;height:50px;margin-top:30px" src="img/add-care.svg" type="image/svg+xml"/>
        <embed style="float: right;height:48px;display: none;margin-top:30px" src="img/icon-cared.svg" type="image/svg+xml"/>
    </div>

    <div class="mainContainer barrage-container-wrap" style="float: left;margin-left: 211px;">
        <div class="video-container  barrage-container">
            <div>
                <video name="videoElement" class="centeredVideo" controls autoplay>
                    Your browser is too old which doesn't support HTML5 video.
                </video>
            </div>
        </div>

        <div class="controls">
            <button onclick="flv_load()" style="margin-top:10px">Load</button>
        </div>

        <textarea name="logcatbox" class="logcatBox" rows="10" readonly style="display: none;"></textarea>
    </div>

    <textarea readonly style="overflow-y:hidden;float: left;height: 492px;width: 20%;margin-left: 100px;margin-top:5px;" name="barrageArea">
    </textarea>

    <div class="box">
        <div class="send-wrap">
            <input type="text" class="input" placeholder="弹幕发送">
            <span class="send-btn">发送</span>
        </div>
    </div>

<script src="js/flv.min.js"></script>

<script>
    $(function(){
        $(".headerpage").load('header.html');
    });
</script>

<script>
    var checkBoxFields = ['isLive', 'withCredentials', 'hasAudio', 'hasVideo'];
    var streamURL, mediaSourceURL;

    function flv_load() {
        console.log('isSupported: ' + flvjs.isSupported());
        if (mediaSourceURL.className === '') {
            var url = document.getElementById('msURL').value;

            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.onload = function (e) {
                var mediaDataSource = JSON.parse(xhr.response);
                flv_load_mds(mediaDataSource);
            }
            xhr.send();
        } else {
            var i;
            var mediaDataSource = {
                type: 'flv'
            };
            for (i = 0; i < checkBoxFields.length; i++) {
                var field = checkBoxFields[i];
                /** @type {HTMLInputElement} */
                var checkbox = document.getElementById(field);
                mediaDataSource[field] = checkbox.checked;
            }
            mediaDataSource['url'] = document.getElementById('sURL').value;
            console.log('MediaDataSource', mediaDataSource);
            flv_load_mds(mediaDataSource);
        }
    }

    function flv_load_mds(mediaDataSource) {
        var element = document.getElementsByName('videoElement')[0];
        if (typeof player !== "undefined") {
            if (player != null) {
                player.unload();
                player.detachMediaElement();
                player.destroy();
                player = null;
            }
        }
        player = flvjs.createPlayer(mediaDataSource, {
            enableWorker: false,
            lazyLoadMaxDuration: 3 * 60,
            seekType: 'range',
        });
        player.attachMediaElement(element);
        player.load();
    }


    function switch_url() {
        streamURL.className = '';
        mediaSourceURL.className = 'hidden';
        saveSettings();
    }

    function switch_mds() {
        streamURL.className = 'hidden';
        mediaSourceURL.className = '';
        saveSettings();
    }

    function ls_get(key, def) {
        try {
            var ret = localStorage.getItem('flvjs_demo.' + key);
            if (ret === null) {
                ret = def;
            }
            return ret;
        } catch (e) {}
        return def;
    }

    function ls_set(key, value) {
        try {
            localStorage.setItem('flvjs_demo.' + key, value);
        } catch (e) {}
    }

    function saveSettings() {
        if (mediaSourceURL.className === '') {
            ls_set('inputMode', 'MediaDataSource');
        } else {
            ls_set('inputMode', 'StreamURL');
        }
        var i;
        for (i = 0; i < checkBoxFields.length; i++) {
            var field = checkBoxFields[i];
            /** @type {HTMLInputElement} */
            var checkbox = document.getElementById(field);
            ls_set(field, checkbox.checked ? '1' : '0');
        }
        var msURL = document.getElementById('msURL');
        var sURL = document.getElementById('sURL');
        ls_set('msURL', msURL.value);
        ls_set('sURL', sURL.value);
        console.log('save');
    }

    function loadSettings() {
        var i;
        for (i = 0; i < checkBoxFields.length; i++) {
            var field = checkBoxFields[i];
            /** @type {HTMLInputElement} */
            var checkbox = document.getElementById(field);
            var c = ls_get(field, checkbox.checked ? '1' : '0');
            checkbox.checked = c === '1' ? true : false;
        }

        var msURL = document.getElementById('msURL');
        var sURL = document.getElementById('sURL');
        msURL.value = ls_get('msURL', msURL.value);
        sURL.value = ls_get('sURL', sURL.value);
        if (ls_get('inputMode', 'StreamURL') === 'StreamURL') {
            switch_url();
        } else {
            switch_mds();
        }
    }

    function showVersion() {
        var version = flvjs.version;
        document.title = document.title + " (v" + version + ")";
    }

    var logcatbox = document.getElementsByName('logcatbox')[0];
    flvjs.LoggingControl.addLogListener(function(type, str) {
        logcatbox.value = logcatbox.value + str + '\n';
        logcatbox.scrollTop = logcatbox.scrollHeight;
    });

    document.addEventListener('DOMContentLoaded', function () {
        streamURL = document.getElementById('streamURL');
        mediaSourceURL = document.getElementById('mediaSourceURL');
        loadSettings();
        showVersion();
        flv_load();
    });
</script>
<script>
    ;(function(){
        var barrageArray = [

        ];
        var barrageColorArray = [
            'white'
        ];
        var barrageTipWidth = 50; //提示语的长度

        var barrageBoxWrap = document.querySelector('.barrage-container-wrap');;
        var barrageBox = document.querySelector('.barrage-container');
        var inputBox = document.querySelector('.input');
        var sendBtn = document.querySelector('.send-btn');

        //容器的宽高度
        var barrageWidth = ~~window.getComputedStyle(barrageBoxWrap).width.replace('px','');
        var barrageHeight = ~~window.getComputedStyle(barrageBoxWrap).height.replace('px','');

        //发送
        function sendMsg(){
            var inputValue = inputBox.value;
            inputValue .replace(/\ +/g, "");

            if (inputValue.length <= 0) {
                alert('请输入');
                return false;
            }

            //生成弹幕
            createBarrage(inputValue,true);
            inputBox.value = '';
        }


        //创建弹幕
        function createBarrage(msg, isSendMsg){
            var divNode = document.createElement('div');
            var spanNode = document.createElement('span');

            divNode.innerHTML = msg;
            divNode.classList.add('barrage-item');
            barrageBox.appendChild(divNode);

            spanNode.innerHTML = '举报';
            spanNode.classList.add('barrage-tip');
            divNode.appendChild(spanNode);

            barrageOffsetLeft = getRandom(barrageWidth, barrageWidth*2);
            barrageOffsetLeft = isSendMsg ? barrageWidth : barrageOffsetLeft
            barrageOffsetTop = getRandom(20, barrageHeight-60);
            barrageColor = barrageColorArray[Math.floor(Math.random()*(barrageColorArray.length))];

            //执行初始化滚动
            initBarrage.call(divNode,{
                left : barrageOffsetLeft,
                top : barrageOffsetTop,
                color : barrageColor
            });

            addTextArea();
        }

        function addTextArea() {
            var text = inputBox.value;
            var barrageArea = document.getElementsByName('barrageArea')[0];
            barrageArea.value = barrageArea.value + "\n   abc : "+text + '\n';
            barrageArea.scrollTop = barrageArea.scrollHeight;
        }

        //初始化弹幕移动(速度，延迟)
        function initBarrage(obj) {
            //初始化
            obj.top = obj.top || 0;
            obj.class = obj.color || '#fff';
            this.style.left = obj.left + 'px';
            this.style.top = obj.top + 'px';
            this.style.color = obj.color;

            //添加属性
            this.distance = 0;
            this.width = ~~window.getComputedStyle(this).width.replace('px','');
            this.offsetLeft = obj.left;
            this.timer = null;

            //弹幕子节点
            var barrageChileNode = this.children[0];
            barrageChileNode.style.left = (this.width-barrageTipWidth)/2 + 'px';

            //运动
            barrageAnimate(this);

            //停止
            this.onmouseenter = function(){
                barrageChileNode.style.display= 'block';
                cancelAnimationFrame(this.timer);
            };

            this.onmouseleave = function(){
                barrageChileNode.style.display = 'none';
                barrageAnimate(this);
            };

            //举报
            barrageChileNode.onclick = function(){
                alert('举报成功');
            }
        }

        //弹幕动画
        function barrageAnimate(obj){
            move(obj);

            if(Math.abs(obj.distance) < obj.width+obj.offsetLeft){
                obj.timer = requestAnimationFrame(function(){
                    barrageAnimate(obj);
                });
            }else{
                cancelAnimationFrame(obj.timer);
                //删除节点
                obj.parentNode.removeChild(obj);
            }
        }

        //移动
        function move(obj){
            obj.distance--;
            obj.style.transform = 'translateX('+obj.distance+'px)';
            obj.style.webkitTransform = 'translateX('+obj.distance+'px)';
        }

        //随机获取高度
        function getRandom(start, end){
            return start +(Math.random() * (end - start ));
        }


        /*******初始化事件**********/
        //系统数据
        barrageArray.forEach(function(item,index){
            createBarrage(item.text, false);
        });

        //点击发送
        sendBtn.onclick = sendMsg;   //点击发送

        //回车
        inputBox.onkeydown = function(e){
            e = e|| window.event;
            if(e.keyCode == 13){
                send();
            }
        }

    })()

    //兼容写法
    (function() {
        var lastTime = 0;
        var vendors = ['webkit', 'moz'];
        for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
            window.requestAnimationFrame = window[vendors[x] + 'RequestAnimationFrame'];
            window.cancelAnimationFrame = window[vendors[x] + 'CancelAnimationFrame'] ||    // Webkit中此取消方法的名字变了
                window[vendors[x] + 'CancelRequestAnimationFrame'];
        }

        if (!window.requestAnimationFrame) {
            window.requestAnimationFrame = function(callback, element) {
                var currTime = new Date().getTime();
                var timeToCall = Math.max(0, 16.7 - (currTime - lastTime));
                var id = window.setTimeout(function() {
                    callback(currTime + timeToCall);
                }, timeToCall);
                lastTime = currTime + timeToCall;
                return id;
            };
        }
        if (!window.cancelAnimationFrame) {
            window.cancelAnimationFrame = function(id) {
                clearTimeout(id);
            };
        }
    }());

</script>
</body>

</html>